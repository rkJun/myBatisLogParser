<!doctype html>
<html lang="ko">
	<head>
		<meta charset="utf-8">
		<title>MyBatis Log parser</title>
		<script src="js/common/tipJS-MVC-dev.js"></script>

		<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
		<link href="css/common.css" rel="stylesheet" media="screen">

		<style type="text/css">
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<form id="defaultForm">

				<div class="page-header">
				  <h1>myBatis Log parser <small>my breakable toys</small></h1>
				</div>

				<div class="row-fluid">
					<span class="label">Original Log :</span>
					<p>
						<textarea id="txt_origin" class="span8" rows="8"></textarea>
					</p>
				</div>

				<div id="div_button_list" class="row-fluid">
					<p>
						<button id="btn_sample" class="btn">Sample</button>
						<button id="btn_parse" class="btn">Parse</button>
						<button id="btn_save" class="btn">Save ParsedSQL</button>
						<button id="btn_remove" class="btn">Remove ParsedSQL</button>
						<button id="btn_list" class="btn">list ParsedSQL</button>
						<span id="span_status"></span>
					</p>
				</div>

				<div class="row-fluid">
					<span class="label">Parsed SQL:</span>
					<p>
						<textarea id="txt_parsing" class="span8" rows="8"></textarea>
					</p>
				</div>
			</form>
		</div>

		<script>
			$(document).ready(function() {

				tipJS.loadApp("app");

				$("#defaultForm").submit(function(e) {
					e.preventDefault();
				});

				$("#div_button_list").on("click", "#btn_parse", function(e) {
					tipJS.action("app.parserController", "parse");
				}).on("click", "#btn_sample", function(e) {
					tipJS.action("app.parserController", "sample");
				});

				/**
				 * myBatis 로그 합치기
				 * Preparing: Select dummy from dual where col = ? and col2 = ?
				 * Parameters: val1(String), val2(String)
				 *
				 * Result) select ... where col = val1 and col2 = val2
				 *
				 * @return {[type]} [description]
				 */

				var doParse = function () {
					var i=0, lastIdx = 0;
					var $txt_origin = $("#txt_origin");
					var $txt_parsing = $("#txt_parsing");

					var originArr = [], parsingArr = [], paramArr = [];
					var paramCnt = 0;
					var result = "";
					var preparing = "";
					var param = {};

					originArr = $txt_origin.val().split("\n");
					parsingArr[0] = originArr[0].substring ( originArr[0].indexOf ("Preparing: ")+11 );
					parsingArr[1] = originArr[1].substring ( originArr[1].indexOf ("Parameters: ")+12 );

					if (originArr.length > 2) {
						for (i =2; i < originArr.length; i++ ) {
							parsingArr[1] += originArr[i];
						}
					}
					preparing  = parsingArr[0];
					paramArr = parsingArr[1].split(",");
					console.log("paramArr:"+paramArr);
					for (i = 0; i < paramArr.length; i++) {
						var tempParams = paramArr[i];
						lastIdx = tempParams.lastIndexOf("(");

						param.val = $.trim ( tempParams.substring(0, lastIdx ) );

						if (lastIdx < 0) {
							param.val  = "null";
						}

						param.typ = tempParams.substring(tempParams.lastIndexOf("(")+1, paramArr[i].lastIndexOf(")"));

						if ( preparing.indexOf("?") >= 0 ) {

							if (param.typ === "String") {
								param.val = "'"+param.val+"'";
							}
							preparing = preparing.replace("?", param.val);
						}

					}
					result = preparing;
					$txt_parsing.html(result);
				};

				$("body").on("click", "button", function (e) {
					//doParse();
				});
				
			});
		</script>
	</body>
</html>

<!--
DEBUG: java.sql.Connection - ==>  Preparing: SELECT TEST1, TEST2 FROM DUAL WHERE COL1 = ? AND COL2 = ? AND NO = ?
DEBUG: java.sql.PreparedStatement - ==> Parameters: test1(String), test2(String), 13(Long)
 -->
